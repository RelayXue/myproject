<html>
<title>中国电信全球眼</title>
<meta http-equiv="X-UA-Compatible" content="IE=7" />
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<OBJECT id="WebOcx" name="WebOcx" classid="clsid:1ED44FB1-A30D-4172-80C6-A3558144B642" width="0" height="0" VIEWASTEXT codebase="V3ClientOcxsetup20130729.exe#version=1,1,0,3">
</OBJECT>
<link href="/js/OCXDEMO/css/ext-all.css" rel="stylesheet" type="text/css" />
<link href="/js/OCXDEMO/css/global.css" rel="stylesheet" type="text/css" />
<LINK href="/js/OCXDEMO/css/SpryTabbedPanels.css" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="/js/OCXDEMO/js/ext-base.js"></script>
<script type="text/javascript" src="/js/OCXDEMO//js/ext-all.js"></script>
<SCRIPT type="text/javascript" src="/js/OCXDEMO//js/SpryTabbedPanels.js" ></SCRIPT>
<script type="text/javascript" src="/js/OCXDEMO//js/recordSearch.js"></script>
<script type="text/javascript" src="/js/OCXDEMO//js/DateTimeCalendar.js"></script>


<body onload="init();" onunload="Quit();">
	
<!--------------------视频控制块--------------------->

<!--------------------录像检索块--------------------->

<!----------------------------------------->
<div id="header"><div class="text1">首次使用请先安装插件<a href="/js/OCXDEMO//WebOcx.exe">下载</a></div></div>
<div id="contain">
<div id="mainbg">

<DIV class=TabbedPanels id=TabbedPanels1>
<UL class=TabbedPanelsTabGroup>
  <LI class=TabbedPanelsTab tabIndex=0>视频监控</LI> 
  <LI class=TabbedPanelsTab tabIndex=0>录像下载</LI>
  <LI style="width:500px; float:right; display: block;">
 	<form name="form1">
    <table style="width:500px; " border="0" cellspacing="0" cellpadding="0">
  <tr>
  	<td width="45" align="right">登录IP:</td>
    <td width="81"><input type="text" name="loginIp" value="202.107.233.162" style="width:80px; border:1px solid #7F9DB9" /></td>
    <td width="36" align="right">端口:</td>
    <td width="51"><input name="loginPort" type="text" value="6666" style="width:50px; border:1px solid #7F9DB9" /></td>
    <td width="45" align="right">用户名:</td>
    <td width="81"><input type="text" name="userName" value="admin@phdhjq.jx" style="width:80px; border:1px solid #7F9DB9" /></td>
    <td width="36" align="right">密码:</td>
    <td width="51"><input name="userPassword" type="password" value="1234" style="width:50px; border:1px solid #7F9DB9" /></td>
    <td width="63"><img src="images/login.gif" name="login1" onclick="Login();"/></td>
  </tr>
</table></form>
  </LI> 
  
</UL>
<DIV class=TabbedPanelsContentGroup>
<DIV class=TabbedPanelsContent><div id="links">
   
    <div class="text"><div id="righttop0"> <div id="control_header">&nbsp;&nbsp;&nbsp;&nbsp;视频控制</div><form name="form2"><div id="control2"><table width="184" height="115" border="0" cellpadding="0" cellspacing="0">
            
         <tr><td>   
            

</td></tr>
            <tr>
              <td width="39" height="35">&nbsp;</td>
              <td width="49" align="center"><img src="images/y_up.gif" alt="上" name="Image1" width="27" height="32" border="0" id="Image1" onMouseDown="TurnUp();" onMouseUp="StopTurn();" /></td>
              <td width="42" align="left"><img src="images/big.gif" alt="拉近" width="32" height="22" border="0" id="Image6" onMouseDown="LenNear();" onMouseUp="StopTurn();"/></td>
              <td width="54" align="center"><img src="images/auto2.gif" width="35" height="19" border="0" alt="自动对焦" onClick=""/></td>
            </tr>
            <tr>
              <td height="40" align="right"><img src="images/y_left.gif" alt="左" name="Image3" width="32" height="27" border="0" id="Image3" onMouseDown="TurnLeft();" onMouseUp="StopTurn();"/></td>
              <td width="49" align="center"><img src="images/y_middle2.gif" alt="断开视频" name="Image5" width="27" height="27" border="0" id="Image5" onClick="Stop();"/></td>
              <td align="left"><img src="images/y_right.gif" alt="右" name="Image2" width="32" height="27" border="0" id="Image2" onMouseDown="TurnRight();" onMouseUp="StopTurn();"/></td>
              <td width="54" align="center"><img src="images/focusout2.gif" width="35" height="19" border="0" alt="视频调亮" onClick="Brighten();"/></td>
            </tr>
            <tr>
              <td height="36">&nbsp;</td>
              <td width="49" align="center"><img src="images/y_down.gif" alt="下" name="Image4" width="27" height="32" border="0" id="Image4" onMouseDown="TurnDown();" onMouseUp="StopTurn();"/></td>
              <td align="left"><img src="images/small.gif" alt="拉远" width="32" height="22" border="0" id="Image7" onMouseDown="LenFar();" onMouseUp="StopTurn();"/></td>
              <td width="54" align="center"><img src="images/focus2.gif" width="35" height="19" border="0" alt="视频调暗" onClick="Darken();"/></td>
            </tr>
         
          </table>
          
        </div></form><div id="control2">
		  <table width="175" height="30" border="0" cellpadding="0" cellspacing="0">
            
            <tr>
              <td width="47"><img src="images/one_screen.gif" width="35" height="19" border="0" alt="单屏" name="num" onClick="changeScreen(1);"/></td>
              <td width="49"><img src="images/four_screen.gif" width="35" height="19" border="0" alt="四屏" onClick="changeScreen(4);"/></td>
              <td width="47"><img src="images/six_screen.gif" width="35" height="19" border="0" alt="六屏" onClick="changeScreen(6);"/></td>
              <td width="35"><img src="images/nine_screen.gif" width="35" height="19" border="0" alt="九屏" onClick="changeScreen(9);"/></td>
            </tr>
          </table>
		</div></div>
		
		<div id="righttop1" style="display:none"><div id="search_header">&nbsp;&nbsp;&nbsp;&nbsp;录像检索条件:</div>
  <div class="x-form-bd" id="control2">
		<table width="98%"  border="0" cellpadding="0"cellspacing="0" style="margin-top:5px">
					<tr class="x-form-item">
						<td  width="33%" height="30">摄&nbsp;像&nbsp;头：</td>
						<td align="left" width="67%" ><input id="fdNameSelect" type="text"
							style="width: 120px" disabled /><br><font color="blue">(从列表中选相应设备)</font>						</td>
					</tr>
					<tr class="x-form-item">
					  <td  height="28">录像种类：</td>
					  <td align="left" ><select class="x-combo-list"
							name="recordType" id="recordType" style="width: 120px">
                            <option value="0">前端录像</option> 
                            <option value="1">中心录像</option>                                              
                      </select></td>
				    
			        <tr class="x-form-item">
			          <td  height="28">开始时间：</td>
			          <td align="left" ><input type="text" class="Wdate" id="BeginTime_1" style="width:120px" title="开始时间"  onfocus="calendar();"/></td>
		            <tr class="x-form-item">
		              <td  height="28">结束时间：</td>
		              <td align="left" ><input type="text" class="Wdate" id="EndTime_1" style="width:120px"
							title="截至时间"  onfocus="calendar();"/></td>
	              <tr class="x-form-item">
	                <td  height="28"><input type="button"
							class="bbut" onclick="QueryRecord();" value="&nbsp;查询&nbsp;" /></td>
	                <td  height="28">
                    <input type="button" class="bbut" onclick="PlayRecord()"
							value="&nbsp;回放&nbsp;" /></td>
                  <td  height="28">
                    <input type="button" class="bbut" onclick="DownloadRecord()"
							value="&nbsp;下载&nbsp;" /></td>
                  </tr>                 
                </table>
			  </div></div>

        <div id="rightbottom"> 
        <div id="list_header"></div>
        <div id="tree-div"></div>
</div>
        </div>
</div><div id="main0">
 <div class="text3"><OBJECT id="VOcx" name="VOcx" classid="clsid:41574951-5BCE-4577-AAAB-70A8E3C2E891" width="0px" height="0px" VIEWASTEXT >
</OBJECT></div>
</div>

<div id="main1">
 <div class="text">
  </div>
</div>

<div id="main2" style="display:none">
<div class="x-form-bd" id="container">
  <div class="x-form-bd" id="south_div">
		<div id="videoSearch_Div">
		<div id="searchgrid" style="border: 0px solid #b5b8c8; height: 130px;"></div>
		</div>
		</div>
</div>
</div>

</DIV>


<DIV class=TabbedPanelsContent style="display:none"></div>

</DIV>
</DIV>
<SCRIPT type=text/javascript>
<!--
var TabbedPanels1 = new Spry.Widget.TabbedPanels("TabbedPanels1");
//-->
</SCRIPT>
</div>
</div>
<div id="footer"></div>
<div>

</div>

<script language="javascript">

	var hwnd;
	var hwnd1;
	var tempNode;
	var FDListString11;
	var tmpStr_array;
	var sCameraID="";
	var sChannelID="";
	var b_HasLogin=false;
	var tree,rootNode;
	var sDstFilePath="C:\\myrecord\\";
	
//初始化OCx控件
function init()
{
	hwnd = VOcx.Initial(12, 12, 552, 418, 0);	
	VOcx.SetWindowsNumber(1);
	lResult = WebOcx.Initial(0);	
	 var	lResult = 1;
		var userName = "admin@phdhjq.jx";
		var userPassword = "1234";
		var loginIp = "202.107.233.162";
		var loginPort = "6666";

      lResult = WebOcx.Login(loginIp,loginPort,"",userName,userPassword);
	  if(lResult != 0){
			alert("登陆失败!");
		}else{
//			alert("登录成功！");
			WebOcx.GetDeviceList();
		}
	
	  sCameraID = "125000000100003133";
	 sChannelID = "3";
	re = WebOcx.PlayVideo(hwnd,sCameraID,sChannelID);
	
//alert("init");
}
//创建数组
function IniArray(size)
{
  for(var i = 0; i < size; i++)
  {
    this[i] = "";
  }
  this.length=size;
  return this;
}
//登陆方法
function Login()
{
    var	lResult = 1;
		var userName = document.form1.userName.value;
		var userPassword = document.form1.userPassword.value;
		var loginIp = document.form1.loginIp.value;
		var loginPort = document.form1.loginPort.value;
		
		if(userName==null || userName==""){
		alert("帐号不能为空，请重新填写！");
		return false;
	   }
	  if(userPassword==null || userPassword==""){
		alert("密码不能为空，请重新填写！");
		return false;
	   }

      lResult = WebOcx.Login(loginIp,loginPort,"",userName,userPassword);

	  if(lResult != 0){
			alert("登陆失败!");
		}else{
//			alert("登录成功！");
			WebOcx.GetDeviceList();
		}
}

//退出平台
function Quit()
{
  WebOcx.Logout();
  WebOcx.Free();
VOcx.Free();
  //alert("quit");
}

//开始视频
function Start()
{
	WebOcx.PlayVideo(hwnd,sCameraID,sChannelID);	
}
//停止视频
function Stop()
{

	//WebOcx.StopVideo(hwnd);
WebOcx.GetUserMPList();

}

//查询预设位
function QueryPreset()
{
  WebOcx.QueryPreset(hwnd);
}
</script>


<script>
//解析字符串
function parseXml(cString) {
	// 然后开始获取 fdInfo.xml 需要的的第一个节点的属性值
//	alert(cString);
	if(tree == "" || typeof(tree) == 'undefined'){
	tree = new Ext.tree.TreePanel('tree-div', {
		animate : true,
		line : true,
		selMode : true,
		rootVisible : true,
		loader : false
	});

	rootNode = new Ext.tree.TreeNode( {
		text : '设备列表',
		draggable : false,
		id : '0'
	});
	
	
	tree.on("click", function(node) {
		if (node != null) {
			if (node.isLeaf()) {
				var TwoID = node.attributes.id;
				sCameraID = TwoID.substring(0,18);
				sChannelID = TwoID.substring(19,20);
			    Ext.get('fdNameSelect').dom.value = node.attributes.text;
			}
		}
	});
	
		tree.on("dblclick", function(node) {
				if (node != null) {
					if (node.isLeaf()) {
					var TwoID = node.attributes.id;
				      sCameraID = TwoID.substring(0,18);
				      sChannelID = TwoID.substring(19,20);				
                 

		  		    WebOcx.StopVideo(hwnd);
					//PanelHandle = WndContainerOcx.GetPanelHandle();// 获得空闲窗口句柄
					alert(sCameraID);
					alert(sChannelID);
					  sCameraID = "125000000100003133";
				      sChannelID = "3";
				      			
					
					re = WebOcx.PlayVideo(hwnd,sCameraID,sChannelID);
	
	         } else {
						if(node.attributes.cls != "folder")
						{
							tempNode = node;
							IniFDID=node.attributes.id;
							var ChannelList = WebOcx.GetChannelList(node.attributes.id);
							node.expand(true);	
			  		}
			  			
			  		else {
			  	    node.collapseChildNodes();
			      }			
		   }
    }
	}		);
}
  var tmpStr_array =cString.split("$");
  
	for (var i = 1;i < tmpStr_array.length; i++) 
		{
	  
	 var tmpStr_array2=tmpStr_array[i].split("|");
	 var fdId = tmpStr_array2[0];
	 var fdName = tmpStr_array2[1];
	 var Status = tmpStr_array2[3];
	 var flag = false;
		
		if(Status == 0)
		{
			flag = true;
		}else{
			flag = false;
		}
		var childNode = new Ext.tree.TreeNode( {
			id : fdId,
			text : fdName,
			icon : 'images/list-items.gif',
			disabled: flag,
			leaf : false
			//cls : 'folder'
		});
		rootNode.appendChild(childNode);
			
	}

	tree.setRootNode(rootNode);
	tree.render();
	rootNode.expand();		
}	

function addChild(node,ChannelListString)
	{
			var chStr_array =ChannelListString.split("$");
			var childLength =chStr_array.length;
			  if (childLength > 0) {
	     for (var j = 1;j < childLength; j++) {
			  
	    var chStr_array2=chStr_array[j].split("|");
	    var channelId = chStr_array2[0];
	    var channelName = chStr_array2[3];
							var childNode = new Ext.tree.TreeNode( {
								id : channelId,
								text : channelName,
								disabled : false,
								icon : 'images/onlineMp.gif',
								leaf : true,
								cls : 'file'
							});
							node.appendChild(childNode);
							node.expand(true);
							node.attributes.cls="folder";						
					}
				}			
}

//云台上转
function TurnUp()
{
	WebOcx.PTZControlEx(hwnd,1,5); 
}
//云台下转
function TurnDown()
{ 
    WebOcx.PTZControlEx(hwnd,2,5);
}		
//云台的左转
function TurnLeft()
{
       
   WebOcx.PTZControlEx(hwnd,3,5);
}
//云台的右转
function TurnRight()
{   
    WebOcx.PTZControlEx(hwnd,4,5);
}

//变亮
function Brighten()
{
    WebOcx.PTZControlEx(hwnd,5,5);
}
//变暗
function Darken()
{
    WebOcx.PTZControlEx(hwnd,6,5);
}
//停止转动
function StopTurn()
{
    WebOcx.PTZControlEx(hwnd,0,5);   
}
//拉远镜头
function LenFar()
{
    WebOcx.PTZControlEx(hwnd,8,5);
}
//拉近镜头
function LenNear()
{
    WebOcx.PTZControlEx(hwnd,7,5);
}
//改变窗口数目
function changeScreen(lWndNumber)
{	 
	  VOcx.SetWindowsNumber(lWndNumber);	 
}

	function cacthPicture(){
		var sFullID = WebOcx.GetCameraIDEx(hwnd);
		var picfullpath;
		var picPath = "c:\\SURFINGEYE\\PIC\\"; //本地抓图路径
		if (sFullID == "" || sFullID == "undefined") {
	        alertMsg.error('获取监控点失败！');
		} else {
			if(sFullID.length == 20){
				picfullpath = picPath + sFullID + "_" + getCurrentTime() +".jpg";
			}else{
				var sMpID = sFullID.substring(7,25) + sFullID.substring(33,35);
				var fileName = sMpID + "_" + getCurrentTime() +".jpg";
				picfullpath = picPath + fileName;
			}
		    //alert(picfullpath);
			rs = WebOcx.CaptureImage(hwnd,picfullpath);
			if (rs == 0) {
		        alert('抓图成功！');
			} else {
		        alert('抓图失败');
			}
		}

	}
	//开始录像
	function startRec(){
		var recPath = "c:\\SURFINGEYE\\RECORD\\"; //本地抓图路径
		var sFullID = WebOcx.GetCameraIDEx(hwnd);
		var recfullpath;
		if (sFullID == "" || sFullID == "undefined") {
	        alertMsg.error('获取监控点失败！');
	        return;
		}
		if(sFullID.length == 20){
			recfullpath = recPath + sFullID + "_" + getCurrentTime();
		}else{
			var sMpID = sFullID.substring(7,25) + sFullID.substring(33,35);
			var sCameraID = sFullID.substring(7,25);
			var sChannelID = sFullID.substring(33,35);
			var fileName = sMpID + "_" + getCurrentTime();
			recfullpath = recPath + fileName;
		}
		rs = WebOcx.StartRecordEx(hwnd, recfullpath);
		if (rs != 0) {
			alert('开始录像失败！');
		}else{
			alert('开始录像！');
		}
	}
	//结束录像
	function  stopRec() {
		rs = WebOcx.StopRecordEx(hwnd);
	    if (rs == 0) {
			alert('停止录像成功！');
		} else {
			alert('停止录像失败！');
		}

	}

//获取当前时间
	function getCurrentTime(){
		var date = new Date(); 
		var yy = date.getFullYear(); 
		var MM = date.getMonth() + 1; 
		if(MM<10) MM = "0" + MM;
			var dd=date.getDate(); 
		if(dd<10) dd = "0" + dd;
			var hh=date.getHours(); 
		if(hh<10) hh = "0" + hh;
			var mm=date.getMinutes(); 
		if(mm<10) mm = "0" + mm;
			var ss=date.getSeconds(); 
		if(ss<10) ss = "0" + ss;
			var sss=date.getMilliseconds();  
		return (yy + MM + dd + hh + mm + ss + sss); 
	}
</script>


<script language="javascript" for="WebOcx" event="NotifyRecordMessage(sCameraID, sList);">
	
    getRecordList(sList);
    
</script>

<script language="javascript" for="WebOcx" event="NotifyDeviceListMessage(sDeviceList);">
	//alert("NotifyDeviceListMessage(),sDeviceList="+sDeviceList);
//	FDListString = sDeviceList;
  parseXml(sDeviceList);
	  
</script>

<script language="javascript" for="WebOcx" event="NotifyChannelMessage(sChannels);">

	var ChannelListString = sChannels;	
  addChild(tempNode,ChannelListString);
	
</script>

<script language="javascript" for="VOcx" event="OnChangeFocus(hWnd);">
	hwnd = hWnd;
</script>

<script language="javascript" for="WebOcx" event="OnMessage(hWnd, sCameraID, lMsgID, sMessage);">
//	alert(sMessage);
</script>

<script language="javascript" for="WebOcx" event="NotifyUserMPListMessage(sMPListInfo);">
        alert(sMPListInfo);
</script>

<!----窗口状态设置事件---->
<script language="javascript" for="WebOcx" event="ChangePlayWindowStatus(hWnd,lStatus,lType);">
//	alert("ChangePlayWindowStatus,lType="+lType);
	VOcx.ChangePlayWindowStatus(hWnd,lStatus);
</script>

<!----窗口关闭视频事件---->
<script language="javascript" for="VOcx" event="StopVideo(hWnd);">
	 WebOcx.StopVideo(hWnd);
	 WebOcx.StopPlayRecord(hWnd);
</script>
<!----关闭全部视频事件---->
<script language="javascript" for="VOcx" event="StopAllMonitor();">
	 WebOcx.StopAllMonitor();
</script>

<!--本地截图事件-->
<script language="javascript" for="VOcx" event="CaptureImage(hWnd);">
	hwnd = hWnd;
	cacthPicture();
</script>
<!--开始本地录像事件-->
<script language="javascript" for="VOcx" event="StartLocalRecord(hWnd);">
	hwnd = hWnd;
	startRec();
</script>
<!--停止本地录像事件-->
<script language="javascript" for="VOcx" event="StopLocalRecord(hWnd);">
	hwnd = hWnd;
	stopRec();
</script>

<script language="javascript" for="WebOcx" event="SetRecordRange(hWnd, lRange);">
  
</script>

</body>
</html>